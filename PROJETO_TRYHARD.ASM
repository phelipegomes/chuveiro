#INCLUDE <P16F628A.INC>	;ARQUIVO PADRÃO MICROCHIP PARA 16F628A
	__CONFIG _BODEN_ON & _CP_OFF & _PWRTE_ON & _WDT_OFF & _WDT_OFF & _LVP_OFF & _MCLRE_OFF & _INTRC_OSC_NOCLKOUT

#DEFINE		BANK0	BCF STATUS,RP0	;SETA BANK0 DE MEMÓRIA
#DEFINE		BANK1	BSF	STATUS,RP0	;SETA BANK1 DE MEMÓRIA

;-------------------DEFINICOES DE BOTOES-------------------------;
#DEFINE		BOTAO_START		PORTA,2		;BOTAO DE START NA ROTINA CONFIGURACAO
#DEFINE		BOTAO_INC		PORTA,4		;BOTAO DE INCREMENTO
#DEFINE		BOTAO_DEC		PORTA,6		;BOTAO DE DECREMENTO
#DEFINE		CLEAR 			PORTA,5		;BOTAO PARA RESETAR A CONFIGURACAO
;-------------------DEFINICOES DE PINOS--------------------------; 
#DEFINE		TRANSISTOR		PORTA,7		;PINO ONDE SE ENCONTRA O TRANSISTOR QUE LIGA O ACIONADOR DO RELAY
#DEFINE		LED_CONFIG		PORTA,0		;LED QUE SINALIZA O MODO DE CONFIGURACAO
#DEFINE		LED_EXE			PORTA,1		;LED QUE SINALIZA O MODO DE EXECUCAO
#DEFINE		SENSOR			PORTA,3		;PINO QUE RECEBE O SINAL DO SENSOR DE CORRENTE
;-------------------DEFINICOES DE FLAGS--------------------------;
#DEFINE 	MODE 			FLAGS,0		;SINALIZA O MODO EM QUE O PIC ESTA, 0 PARA EXECUCAO E 1 PARA CONFIGURACAO
#DEFINE		VALOR_MUDOU		FLAGS,4

CBLOCK	0x20					
;CBLOCK EH O ENDEREÇO INICIAL DA MEMÓRIA DE USUÁRIO EH AQUI QUE CRIAMOS AS VARIAVEIS (REGISTRADORES)

	REG_UNI			;VARIAVEL QUE GUARDA O VALOR DO DISPLAY DE UNIDADE
	REG_DEZ			;VARIAVEL QUE GUARDA O VALOR DO DISPLAY DE DEZENA
	TEMPO_CHUVEIRO	;REGISTRADOR DE TEMPO PARA NOSSO REGISTRADOR QUE DECREMENTA E INCREMENTA VARIAVEL NO TEMPO NOMINAL DO ACIONAMENTO DO RELAY
	FLAGS			;REGISTRADOR ONDE SAO GUARDADAS AS FLAGS

;----------------------------------------------------------------------------------------------------------------------------REGISTRADORES USADOS EM ROTINAS DE DELAY---------------------------;
	TEMP2			
	TEMP3	
	TEMP4	
	TEMP5
	TEMP6

;---------------------------------------------------------------------------------------------------------------------------------FIM DO BLOCO DE MEMÓRIA DE USUARIO----------------------------;
ENDC	

;----------------------------------------------------------------------------------------------------------------ENDEREÇO INICIAL DE PROCESSAMENTO, O PROGRAMA COMECA A SER RODADO DAQUI--------;	
	ORG 0x00					
	
	BANK0
	MOVLW	B'00000111'
	MOVWF	CMCON
	
	BANK1
	;CONFIGURA ENTRADAS E SAIDAS DO PORT A
	MOVLW	B'01111100'
	MOVWF	TRISA
	;CONFIGURA ENTRADAS E SAIDAS DO PORT A
	MOVLW	B'00000000'
	MOVWF	TRISB
	;SEI LA O QUE CONFIGURA
	MOVLW	B'10000100'
	MOVWF	OPTION_REG
	;CONFIGURA REGISTRADOR DE INTERRUPCOES
	MOVLW	B'00000000'
	MOVWF	INTCON

	BANK0
;----------------------------------------------------------------------------------------------------------------------------------VALOR PADRAO DE TODAS AS VARIAVEIS---------------------------;
	BCF		VALOR_MUDOU
	CLRF	REG_DEZ
	CLRF	PORTA
	CLRF	PORTB
	CLRF	FLAGS
	CLRF	TEMP2
	CLRF	TEMP3	
	CLRF	TEMP4
	CLRF	TEMP5
	CLRF	TEMP6
	MOVLW	.1
	MOVWF	TEMPO_CHUVEIRO
	MOVLW	.1
	MOVWF	REG_UNI
	GOTO	MAIN

;-----------------------------------------------------------------------------------------------------------------------------------------ROTINA DE DELAY 1SEGUNDO------------------------------;	
_DL2
	MOVLW	.4
	MOVWF	TEMP4
	;TEMP4 = 4;

_DL3
	MOVLW	.250
	MOVWF	TEMP5
	;TEMP5 = 250;
_DL4
	MOVLW	.200
	MOVWF	TEMP6
	;TEMP6 = 200;
_DL5
	NOP
	NOP	
	DECFSZ	TEMP6,F
	GOTO	_DL5	
	DECFSZ	TEMP5,F	
	GOTO	_DL4
	DECFSZ	TEMP4,F
	GOTO	_DL3
	RETURN
;-------------------------------------------------------------------------------------------------------------------------------------------ROTINA DE DELAY 5MINUTOS----------------------------;
DELAY4M
	MOVLW	.250
	MOVWF	TEMP3	

_DELAY1S
	MOVLW	.4
	MOVWF	TEMP4
	
_DELAY250mS
	MOVLW	.250
	MOVWF	TEMP5

_DELAY200uS
	MOVLW	.200
	MOVWF	TEMP6

_DELAY5uS
	NOP
	NOP
	DECFSZ	TEMP6,F
	GOTO	_DELAY5uS
	DECFSZ	TEMP5,F	
	GOTO	_DELAY200uS
	DECFSZ	TEMP4,F
	GOTO	_DELAY250mS
	DECFSZ	TEMP3,F
	GOTO	_DELAY1S
	RETURN
;----------------------------------------------------------------------------------------------------------------------------------------ROTINA DE DELAY PRINCIPAL-----------------------------;

DELAY

	MOVF	TEMPO_CHUVEIRO,W
	MOVWF	TEMP2

DL1	
	MOVLW	.60
	MOVWF	TEMP3
	;MOVE 3 PARA COMPARAR COM O TEMP2 PARA LIGAR O LED
	MOVLW	.3
	XORWF	TEMP2,W
	BTFSS	STATUS,Z
	;SE O TESTE FOR 0 LIGA O LED_EXE, SE 1 CONTINUA A COMPARAÇAO
	GOTO	DL2
	BSF		LED_EXE
	;TEMP3 = 2

DL2
	MOVLW	.4
	MOVWF	TEMP4
	
	;TEMP4 = 2;

DL3
	MOVLW	.250
	MOVWF	TEMP5
	;TEMP5 = 250;

DL4
	MOVLW	.200
	MOVWF	TEMP6
	;TEMP6 = 200;

DL5	
	NOP
	NOP	
	DECFSZ	TEMP6,F
	GOTO	DL5	
	DECFSZ	TEMP5,F	
	GOTO	DL4
	DECFSZ	TEMP4,F
	GOTO	DL3
	DECFSZ	TEMP3,F
	GOTO	DL2
	DECFSZ	TEMP2,F
	GOTO	DL1
	
	RETURN
;---------------------------------------------------------------------------------------------------------------------------------------------------ROTINA DE LIMPEZA---------------------------;
CLEAR_CONFIG

	CLRF	REG_UNI
	MOVLW	.1
	MOVWF	REG_UNI
	CLRF	TEMPO_CHUVEIRO
	MOVLW	.1
	MOVWF	TEMPO_CHUVEIRO
	CLRF	REG_DEZ
	BCF		TRANSISTOR
	RETURN
;------------------------------------------------------------------------------------------------------------ROTINA DE INCREMENTO NO REGISTRADOR REG_UNI E TEMPO_CHUVEIRO-----------------------;
INCREMENTO
	
	;SETA A FLAG DE MUDANCA DE VALOR
	BSF		VALOR_MUDOU
	;INCREMENTA TEMPO_CHUVEIRO E O REGISTRADOR DE UNIDADE
	;INCF	TEMP2,F
	INCF	TEMPO_CHUVEIRO,F
	INCF	REG_UNI,F
	;TESTA SE O REGISTRADOR DE UNIDADE CHEGOU EM 10
	MOVLW	.10
	XORWF	REG_UNI,W
	BTFSS	STATUS,Z
	;SE NAO ESTIVER EM 10 RETORNA
	RETURN
	;SE ESTIVER EM 10 ZERA O REGISTRADOR DE UNIDADE, INCREMENTA O REGISTRADOR DA DEZENA E RETORNA
	INCF	REG_DEZ
	CLRF	REG_UNI
	RETURN
;------------------------------------------------------------------------------------------------------------ROTINA DE DECREMENTO NO REGISTRADOR REG_DEZ E TEMPO_CHUVEIRO-----------------------;
DECREMENTO
	
	;SETA A FLAG DE MUDANCA DE VALOR 
	BSF		VALOR_MUDOU
	;DECREMENTA TEMPO_CHUVEIRO E REG_UNI
	DECF	TEMPO_CHUVEIRO,F
	DECF	REG_UNI,F  		
	MOVLW	.0
	XORWF	REG_UNI,W
	BTFSS	STATUS,Z
	;SE NAO ESTAR EM VALOR .0 IRÁ RETORNAR, SE ESTIVER NO VALOR ZERO IRÁ CONTINUAR E MOVERÁ 9 PARA REGISTRADOR DE UNIDADE
	RETURN
	DECF	REG_DEZ,F
	MOVLW	.9
	MOVWF	REG_UNI
	RETURN
;---------------------------------------------------------------------------------------------------------------------------------------------ROTINA PRINCIPAL----------------------------------; 
MAIN
	MOVWF	PORTB
	;BTFSS	MODE
	;GOTO 	EXECUCAO
	GOTO 	CONFIGURACAO
;--------------------------------------------------------------------------------------------------------------------------------------------ROTINA DE EXECUCAO---------------------------------;	
EXECUCAO        							    
 	;BTFSS	MODE			;TESTA O MODO SE FOR 1 VAI PARA CONFIGURACAO, SE FOR 0 CONTINUA A ROTINA DE EXECUCAO
	BCF		TRANSISTOR
	;MOSTRA O ESTADO DE FUNCIONAMENTO COM O LED DE EXECUCAO
	BCF		LED_EXE
	BCF		LED_CONFIG
	;TESTA O PINO DO SENSOR, NAO IRA CONTINUAR A ROTINA SE CASO O SENSOR NAO SER SETADO EM 1
	BTFSS	SENSOR
	GOTO	$ - 2
	;INICIO DA ROTINA DE DELAY ESTIPULADA NA CONFIGURACAO
	CALL	DELAY
	;AO TERMINO DO DELAY, ELE INDICA COM OS DOIS LEDS LIGADOS O TEMPO FALTA 5MIN PARA FEXAR O CIRCUITO DE POTENCIA
	BSF		LED_EXE
	BSF		LED_CONFIG
	;DEPOIS TEMOS O TEMPO DE ESPERA ANTES DE DESLIGAR O CIRCUITO DE POTENCIA
	CALL	DELAY4M
	;LIGA O PINO ONDE ESTA LIGADO O CIRCUITO DE POTENCIA, FEXANDO O CIRCUITO
	BSF		TRANSISTOR
	;TESTA O BOTAO DE START, SE FOR 0, VOLTA PRA EXECUCAO REPETINDO O MESMO CICLO DE ACIONAMENTO
	GOTO	CONFIGURACAO		
	
;--------------------------------------------------------------------------------------------------------------------------------------------ROTINA DE CONFIGURACAO-----------------------------;			
CONFIGURACAO
	;BOTAO CLEAR PARA APAGAR A CONFIGURACAO E RELFAZE-LA
	BTFSS	CLEAR
	GOTO	PASSO_0
	CALL	CLEAR_CONFIG
	
	PASSO_0
	;TESTA NO MEIO DA ROTINA PARA DAR PARTIDA NO TIMER CONFORME A CONFIGURACAO
	BTFSS	BOTAO_START
	GOTO	PASSO_1
	GOTO	EXECUCAO

	PASSO_1
	;SINALIZA QUE ESTÁ EM MODO DE CONFIGURAÇÃO
	BSF		LED_CONFIG
	BCF		LED_EXE	

	PASSO_2
	;TESTA O BIT DO REGISTRADOR RA4 (BOTAO DE INCREMENTO)SE FOR UM ELE PULA UMA LINHA DA ROTINA
	BTFSS	BOTAO_INC
	GOTO 	PASSO_3
	;ESPERA QUE O BOTAO SEJA SOLTO
	BTFSS	BOTAO_INC
	GOTO	$ + 2
	GOTO	$ - 2
	CALL	INCREMENTO

	PASSO_3
	;TESTA O BIT DO REGISTRADOR RA6 (BOTAO DE DECREMENTO)SE FOR UM ELE PULA UMA LINHA DA ROTINA
	BTFSS	BOTAO_DEC
	GOTO 	PASSO_4
	;ESPERA QUE O BOTAO SEJA SOLTO
	BTFSS	BOTAO_DEC
	GOTO	$ + 2
	GOTO	$ - 2
	CALL	DECREMENTO	

	PASSO_4
	;ATUALIZA VALOR NO DISPLAY
	
	;TESTA SE ALGUMA MUDANCA OCORREU
	BTFSS	VALOR_MUDOU
	;SE NAO APENAS CONTINUA
	GOTO	CONFIGURACAO
	;SE SIM ZERA O PORTB PARA QUE SO SEJA NECESSARIO APLICAR MUDANCAS COM BIT = 1
	CLRF	PORTB

	;PRIMEIRA METADE = DISPLAY DA UNIDADE
	BTFSS	REG_UNI,0
	GOTO	$ + 2
	BSF		PORTB,0
	BTFSS	REG_UNI,1
	GOTO	$ + 2
	BSF		PORTB,1
	BTFSS	REG_UNI,2
	GOTO	$ + 2
	BSF		PORTB,2
	BTFSS	REG_UNI,3
	GOTO	$ + 2
	BSF		PORTB,3

	;SEGUNDA METADE = DISPLAY DA DEZENA
	BTFSS	REG_DEZ,0
	GOTO	$ + 2
	BSF		PORTB,4
	BTFSS	REG_DEZ,1
	GOTO	$ + 2
	BSF		PORTB,5
	BTFSS	REG_DEZ,2
	GOTO	$ + 2
	BSF		PORTB,6
	BTFSS	REG_DEZ,3
	GOTO	$ + 2
	BSF		PORTB,7
	;LIMPA A FLAG DE MUDANCA DE VALOR, POIS O VALOR FOI ATUALIZADO
	BCF		VALOR_MUDOU
	GOTO 	CONFIGURACAO

	PASSO_5
	;INVERTE O MODO, SE ESTIVER EM 
	BTFSS	FLAGS,2		    ;TESTAR O BIT 2 DO REGISTRADOR W_TEMP, SE FOR 1 INVERTE PARA 0 DUAS LINHAS ABAIXO, SE FOR ZERO INVERTE PARA 1 UMA LINHA ABAIXO
	GOTO	$+3
	BCF		FLAGS,2
	GOTO	$+2
	BSF		FLAGS,2		    ;APAGA BIT NO REGISTRADOR `W_TEMP` NA POSICAO 2
	GOTO	MAIN				
	;GOTO	EXECUCAO
			
	END